name: Security Gate - Full SAST

on:
  push:
    branches:
      - main
      - dev
  pull_request:

jobs:
  semgrep_gate:
    runs-on: ubuntu-latest

    steps:
    # ----- Étape 1 : Checkout du repo -----
    - name: Checkout repository
      uses: actions/checkout@v3

    # ----- Étape 2 : Installer Python et Semgrep -----
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install Semgrep
      run: pip install semgrep

    # ----- Étape 3 : Installer dépendances (optionnel) -----
    - name: Install dependencies
      run: |
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    # ----- Étape 4 : Lancer le scan Semgrep -----
    - name: Run Semgrep on all Python files
      run: |
        mkdir -p security_reports
        semgrep --config "p/ci" --json > security_reports/semgrep_report.json || true
        semgrep --config "p/ci" > security_reports/semgrep_report.txt || true

    # ----- Étape 5 : Vérifier les vulnérabilités critiques -----
    - name: Fail pipeline if critical vulnerabilities found
      run: |
        if grep -q "error" security_reports/semgrep_report.txt; then
          echo "❌ Critical vulnerabilities detected! Failing pipeline."
          exit 1
        else
          echo "✅ No critical vulnerabilities found."
        fi

    # ----- Étape 6 : Publier les rapports comme artifacts -----
    - name: Upload Semgrep reports
      uses: actions/upload-artifact@v3
      with:
        name: semgrep_reports
        path: security_reports/
